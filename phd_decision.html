<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>PhD Decision Calculator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="shared.css">
  <script src="shared.js"></script>
  <style>
    .chart-container { background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; margin-top: 1rem; }
    .chart-title { font-size: 0.9rem; font-weight: 600; color: var(--text); margin-bottom: 0.75rem; }
    .chart-toolbar { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .chart-toolbar span { font-size: 0.8rem; color: var(--muted); margin-right: 0.25rem; }
    .chart-toolbar .range-btn { padding: 0.35rem 0.65rem; font-size: 0.8rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer; font-family: inherit; }
    .chart-toolbar .range-btn:hover { border-color: var(--accent); color: var(--accent); }
    .chart-toolbar .range-btn.active { background: rgba(56, 189, 248, 0.15); border-color: var(--accent); color: var(--accent); }
    #assetChart { width: 100%; height: 320px; display: block; max-height: 50vh; }
    .input-group label { font-size: 0.8rem; }
    .cols-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; align-items: start; }
    @media (max-width: 700px) { .cols-row { grid-template-columns: 1fr; } }
    .col-card { background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
    .col-card h3 { margin: 0 0 1rem; font-size: 1rem; font-weight: 600; color: var(--text); }
    .col-card .section-label { font-size: 0.75rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin: 1rem 0 0.5rem; padding-bottom: 0.25rem; border-bottom: 1px solid var(--border); }
    .col-card .section-label:first-of-type { margin-top: 0; }
    .col-card .input-group { margin-bottom: 1rem; }
    .col-card .input-group:last-child { margin-bottom: 0; }
    .shared-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.25rem; }
    @media (max-width: 600px) { .shared-row { grid-template-columns: 1fr 1fr; } }
    .collapsible-bar { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 0.9rem; background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; margin-top: 1.25rem; font-size: 0.9rem; color: var(--muted); }
    .collapsible-bar:hover { filter: brightness(1.05); }
    .collapsible-bar .arrow { transition: transform 0.2s; }
    .collapsible-bar.collapsed .arrow { transform: rotate(-90deg); }
    .collapsible-content { margin-top: 0.75rem; }
    .collapsible-content.hidden { display: none; }
    .savings-row { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
    .savings-row label { margin-bottom: 0; flex: 0 0 auto; min-width: 0; }
    .savings-row .savings-mode { min-width: 140px; }
    .savings-row .savings-value { flex: 1; min-width: 80px; }
    .muted-inline { font-size: 0.85rem; color: var(--muted); }
    .toggle-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    .toggle-row input[type="checkbox"] { width: auto; accent-color: var(--accent); cursor: pointer; }
    .toggle-row label { margin: 0; cursor: pointer; font-size: 0.9rem; }
    .invisible-asset-wrap { margin-left: 1.5rem; margin-top: 0.75rem; display: none; }
    .invisible-asset-wrap.visible { display: block; }
    .layoff-detail { margin-top: 0.5rem; display: none; }
    .layoff-detail.visible { display: block; }
    .result-area.visible { display: block; }
    .table-container { margin-top: 1.25rem; background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; overflow-x: auto; }
    .table-container .chart-title { margin-bottom: 0.75rem; }
    .year-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; font-family: "JetBrains Mono", ui-monospace, monospace; }
    .year-table th, .year-table td { padding: 0.5rem 0.6rem; text-align: right; border-bottom: 1px solid var(--border); }
    .year-table th { font-family: "DM Sans", sans-serif; font-weight: 600; color: var(--muted); text-align: right; }
    .year-table th.th-year { vertical-align: middle; }
    .year-table th[colspan="3"] { text-align: center; }
    .year-table td:first-child, .year-table td.td-year { font-weight: 500; color: var(--text); }
    .year-table tr:hover td { background: rgba(56, 189, 248, 0.06); }
    .year-table .col-not-go { border-left: 2px solid rgba(56, 189, 248, 0.4); }
    .year-table .col-go { border-left: 2px solid rgba(52, 211, 153, 0.4); }
    .year-table .graduation-row { background: rgba(248, 113, 113, 0.08); }
  </style>
</head>
<body class="tool-page">
  <a href="index.html" class="nav-float" title="Home">☰</a>
  <div class="app">
    <aside class="sidebar">
      <h2>Explorer</h2>
      <div class="sidebar-section">
        <div class="sidebar-label">Navigate</div>
        <div class="tool-links">
          <a class="tool-link" href="index.html">Home</a>
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">Civil Engineering</div>
        <div class="tool-links">
          <a class="tool-link" href="elastic.html">Elastic constants</a>
          <a class="tool-link" href="unit.html">Unit conversion</a>
          <a class="tool-link" href="pdf-editor.html">PDF editor</a>
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">Personal Finance</div>
        <div class="tool-links">
          <a class="tool-link" href="compound_interest.html">Compound Interest</a>
          <a class="tool-link" href="real_estate.html">Real Estate</a>
          <a class="tool-link" href="passive_income.html">Passive Income</a>
          <a class="tool-link active" href="phd_decision.html">PhD Decision</a>
          <a class="tool-link" href="save_vs_graduate.html">Save vs Graduate</a>
        </div>
      </div>
    </aside>
    <main class="main">
      <div class="container">
        <h1>PhD Decision Calculator</h1>
        <p class="subtitle">Compare asset growth over time: staying in the workforce vs. doing a PhD. Optionally add the estimated value of publications (intangible asset).</p>

        <div class="card card-formulas">
          <div class="collapsible-bar" id="formulasBar" onclick="toggleFormulas()">
            <span>Formulas (per year)</span>
            <span class="arrow">▼</span>
          </div>
          <div class="collapsible-content" id="formulasContent">
            <p class="hint" style="margin-top: 0.5rem;"><strong>Not go:</strong> For year <em>t</em>, salary<sub>t</sub> = salary<sub>0</sub> × (1 + g)<sup>t</sup>; savings<sub>t</sub> = rate% × salary<sub>t</sub> or 12 × ($/month); asset<sub>t+1</sub> = asset<sub>t</sub> × (1 + r) + savings<sub>t</sub>.</p>
            <p class="hint"><strong>Go (during PhD, year t &lt; G):</strong> salary = stipend; savings = rate% × stipend or 12 × ($/month); asset<sub>t+1</sub> = asset<sub>t</sub> × (1 + r) + savings.</p>
            <p class="hint"><strong>Go (after PhD, year t ≥ G):</strong> same layout as Not go: salary grows by “Salary growth (%)”; savings use “Savings” (rate % or $/month). Total asset = financial asset + papers value (if enabled). <em>G</em> = graduation year.</p>
            <p class="hint"><strong>Layoff (optional, both paths):</strong> when enabled and “after <em>K</em> years” is set, from year <em>K</em> onward for that path: no salary or savings; asset only compounds: asset<sub>t+1</sub> = asset<sub>t</sub> × (1 + r). When employed, calculations and toggles are the same for both.</p>
          </div>
        </div>

        <div class="card">
          <div class="shared-row">
            <div class="input-group">
              <label>Starting amount ($)</label>
              <input type="number" id="startAmount" value="25000" min="0" step="1000">
            </div>
            <div class="input-group">
              <label>PhD years</label>
              <input type="number" id="phdYears" value="5" min="1" max="15" step="1">
            </div>
            <div class="input-group">
              <label>Interest rate (%)</label>
              <input type="number" id="interestRate" value="5" min="0" step="0.1">
            </div>
            <div class="input-group">
              <label>Inflation rate (%)</label>
              <input type="number" id="inflationRate" value="2" min="0" step="0.1">
            </div>
          </div>

          <div class="cols-row">
            <div class="col-card">
              <h3>Not go</h3>
              <div class="input-group">
                <label>Current salary ($/year)</label>
                <input type="number" id="noPhdSalary" value="82000" min="0" step="1000">
              </div>
              <div class="input-group">
                <label>Salary growth (%/year)</label>
                <input type="number" id="noPhdSalaryGrowth" value="3.5" min="0" step="0.1">
              </div>
              <div class="input-group">
                <label>Savings</label>
                <div class="savings-row">
                  <select id="noPhdSavingsMode" class="savings-mode">
                    <option value="rate">Savings rate %</option>
                    <option value="amount">Savings $/month</option>
                  </select>
                  <input type="number" id="noPhdSavings" class="savings-value" value="22" min="0" step="1" aria-label="Savings value">
                </div>
              </div>
              <div class="input-group layoff-row">
                <div class="toggle-row">
                  <input type="checkbox" id="noPhdLayoffEnable" aria-label="Enable layoff" onchange="toggleNoPhdLayoffDetail()">
                  <label for="noPhdLayoffEnable">Layoff (optional)</label>
                </div>
                <div class="layoff-detail" id="noPhdLayoffDetail">
                  <div class="savings-row" style="margin-top: 0.5rem;">
                    <input type="number" id="noPhdLayoffAfterYears" value="0" min="0" step="1" placeholder="After year" style="max-width: 6rem;" aria-label="Layoff after year">
                    <span class="muted-inline">years → interest only</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-card">
              <h3>Go</h3>
              <div class="section-label">During PhD</div>
              <div class="input-group">
                <label>PhD stipend ($/year)</label>
                <input type="number" id="phdSalary" value="38000" min="0" step="1000">
              </div>
              <div class="input-group">
                <label>Savings</label>
                <div class="savings-row">
                  <select id="phdSavingsMode" class="savings-mode">
                    <option value="rate">Savings rate %</option>
                    <option value="amount">Savings $/month</option>
                  </select>
                  <input type="number" id="phdSavings" class="savings-value" value="8" min="0" step="1" aria-label="Savings value">
                </div>
              </div>
              <div class="section-label">After PhD</div>
              <div class="input-group">
                <label>Salary after PhD ($/year)</label>
                <input type="number" id="phdPostSalary" value="105000" min="0" step="1000">
              </div>
              <div class="input-group">
                <label>Salary growth (%/year)</label>
                <input type="number" id="phdPostSalaryGrowth" value="3.5" min="0" step="0.1">
              </div>
              <div class="input-group">
                <label>Savings</label>
                <div class="savings-row">
                  <select id="phdPostSavingsMode" class="savings-mode">
                    <option value="rate">Savings rate %</option>
                    <option value="amount">Savings $/month</option>
                  </select>
                  <input type="number" id="phdPostSavings" class="savings-value" value="22" min="0" step="1" aria-label="Savings after PhD">
                </div>
              </div>
              <div class="input-group layoff-row">
                <div class="toggle-row">
                  <input type="checkbox" id="phdLayoffEnable" aria-label="Enable layoff" onchange="togglePhdLayoffDetail()">
                  <label for="phdLayoffEnable">Layoff (optional)</label>
                </div>
                <div class="layoff-detail" id="phdLayoffDetail">
                  <div class="savings-row" style="margin-top: 0.5rem;">
                    <input type="number" id="phdLayoffAfterYears" value="0" min="0" step="1" placeholder="After year" style="max-width: 6rem;" aria-label="Layoff after year">
                    <span class="muted-inline">years → interest only</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="input-group" style="margin-top: 1.25rem;">
            <div class="toggle-row">
              <input type="checkbox" id="includePapers" onchange="togglePapers()">
              <label for="includePapers">Include estimated value of publications (papers stay on CV)</label>
            </div>
            <div class="invisible-asset-wrap" id="invisibleAssetWrap">
              <div class="input-group" style="max-width: 200px; margin-top: 0.5rem;">
                <label>Estimated value of publications ($)</label>
                <input type="number" id="papersValue" value="50000" min="0" step="5000">
              </div>
              <p class="hint" style="margin-top: 0.5rem;">One-time estimate; added to PhD path from graduation year onward.</p>
            </div>
          </div>

          <div class="btn-wrap" style="margin-top: 1.25rem;"><button type="button" class="btn" onclick="calculate()">Compare</button></div>

          <div id="resultArea" class="result-area visible">
            <div class="chart-container">
              <div class="chart-title">Asset growth over time</div>
              <div class="chart-toolbar">
                <span>Time range:</span>
                <button type="button" class="range-btn" data-range="10">10 yr</button>
                <button type="button" class="range-btn" data-range="20">20 yr</button>
                <button type="button" class="range-btn" data-range="30">30 yr</button>
                <button type="button" class="range-btn active" data-range="all">All</button>
              </div>
              <canvas id="assetChart" width="800" height="320"></canvas>
              <p class="hint" style="margin-top: 0.5rem; margin-bottom: 0;">Scroll or pinch to zoom, drag to pan. Use buttons above for 10 / 20 / 30 yr or All.</p>
            </div>
            <div class="table-container">
              <div class="chart-title">Values by year</div>
              <table class="year-table" id="yearTable">
                <thead id="yearTableHead"></thead>
                <tbody id="yearTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.2.0/chartjs-plugin-zoom.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js" crossorigin="anonymous"></script>
  <script>
    let assetChartInstance = null;

    function togglePapers() {
      document.getElementById('invisibleAssetWrap').classList.toggle('visible', document.getElementById('includePapers').checked);
    }
    function toggleNoPhdLayoffDetail() {
      document.getElementById('noPhdLayoffDetail').classList.toggle('visible', document.getElementById('noPhdLayoffEnable').checked);
    }
    function togglePhdLayoffDetail() {
      document.getElementById('phdLayoffDetail').classList.toggle('visible', document.getElementById('phdLayoffEnable').checked);
    }
    function getNoPhdSavings(salary) {
      const mode = document.getElementById('noPhdSavingsMode').value;
      const v = parseFloat(document.getElementById('noPhdSavings').value) || 0;
      return mode === 'rate' ? (salary * v / 100) : (v * 12);
    }
    function getPhdSavings(salary) {
      const mode = document.getElementById('phdSavingsMode').value;
      const v = parseFloat(document.getElementById('phdSavings').value) || 0;
      return mode === 'rate' ? (salary * v / 100) : (v * 12);
    }
    function getPhdPostSavings(salary) {
      const mode = document.getElementById('phdPostSavingsMode').value;
      const v = parseFloat(document.getElementById('phdPostSavings').value) || 0;
      return mode === 'rate' ? (salary * v / 100) : (v * 12);
    }
    function toggleFormulas() {
      document.getElementById('formulasBar').classList.toggle('collapsed');
      document.getElementById('formulasContent').classList.toggle('hidden');
    }
    document.getElementById('formulasBar').classList.add('collapsed');
    document.getElementById('formulasContent').classList.add('hidden');

    window.addEventListener('DOMContentLoaded', function() {
      toggleNoPhdLayoffDetail();
      togglePhdLayoffDetail();
      calculate();
    });

    function calculate() {
      const start = parseFloat(document.getElementById('startAmount').value) || 0;
      const phdYears = Math.max(1, parseInt(document.getElementById('phdYears').value, 10) || 5);
      const r = (parseFloat(document.getElementById('interestRate').value) || 0) / 100;
      const noPhdSalary0 = parseFloat(document.getElementById('noPhdSalary').value) || 0;
      const noPhdGrowth = (parseFloat(document.getElementById('noPhdSalaryGrowth').value) || 0) / 100;
      const phdStipend = parseFloat(document.getElementById('phdSalary').value) || 0;
      const postPhdSalary0 = parseFloat(document.getElementById('phdPostSalary').value) || 0;
      const phdPostGrowth = (parseFloat(document.getElementById('phdPostSalaryGrowth').value) || 0) / 100;
      const includePapers = document.getElementById('includePapers').checked;
      const papersValue = includePapers ? (parseFloat(document.getElementById('papersValue').value) || 0) : 0;
      const noPhdLayoffEnable = document.getElementById('noPhdLayoffEnable').checked;
      const noPhdLayoffYear = Math.max(0, parseInt(document.getElementById('noPhdLayoffAfterYears').value, 10) || 0);
      const phdLayoffEnable = document.getElementById('phdLayoffEnable').checked;
      const phdLayoffYear = Math.max(0, parseInt(document.getElementById('phdLayoffAfterYears').value, 10) || 0);

      const years = Math.max(phdYears + 20, 25);
      const noPhd = [], phd = [];
      const noPhdSalaries = [], noPhdSavings = [], phdSalaries = [], phdSavings = [];
      let aNo = start, aPhd = start;
      let salaryNo = noPhdSalary0;
      let salaryPhdPost = postPhdSalary0;

      for (let y = 0; y <= years; y++) {
        noPhd.push(aNo);
        const phdFinancial = aPhd;
        phd.push(phdFinancial + (y >= phdYears ? papersValue : 0));

        const noPhdLaidOff = noPhdLayoffEnable && noPhdLayoffYear > 0 && y >= noPhdLayoffYear;
        const phdLaidOff = phdLayoffEnable && phdLayoffYear > 0 && y >= phdLayoffYear;

        const salaryNoDisplay = noPhdLaidOff ? 0 : salaryNo;
        const saveNo = noPhdLaidOff ? 0 : getNoPhdSavings(salaryNo);
        const salaryPhd = phdLaidOff ? 0 : (y < phdYears ? phdStipend : salaryPhdPost);
        const savePhd = phdLaidOff ? 0 : (y < phdYears ? getPhdSavings(salaryPhd) : getPhdPostSavings(salaryPhd));

        noPhdSalaries.push(salaryNoDisplay);
        noPhdSavings.push(saveNo);
        phdSalaries.push(salaryPhd);
        phdSavings.push(savePhd);

        aNo = aNo * (1 + r) + saveNo;
        if (!noPhdLaidOff) salaryNo *= (1 + noPhdGrowth);
        aPhd = aPhd * (1 + r) + savePhd;
        if (y >= phdYears && !phdLaidOff) salaryPhdPost *= (1 + phdPostGrowth);
      }

      drawChart(noPhd, phd, years, phdYears, noPhdLayoffEnable, noPhdLayoffYear, phdLayoffEnable, phdLayoffYear);
      fillYearTable(years, phdYears, noPhd, phd, noPhdSalaries, noPhdSavings, phdSalaries, phdSavings, papersValue, includePapers);
      document.getElementById('resultArea').classList.add('visible');
    }

    function fmt(x) {
      if (x >= 1e6) return (x / 1e6).toFixed(2) + 'M';
      return (Math.round(x)).toLocaleString();
    }

    function fillYearTable(years, phdYears, noPhd, phd, noPhdSalaries, noPhdSavings, phdSalaries, phdSavings, papersValue, includePapers) {
      const thead = document.getElementById('yearTableHead');
      const tbody = document.getElementById('yearTableBody');
      thead.innerHTML = '<tr><th rowspan="2" class="th-year">Year</th><th colspan="3" class="col-not-go">Not go</th><th colspan="3" class="col-go">Go</th></tr><tr><th class="col-not-go">Salary</th><th class="col-not-go">Savings</th><th class="col-not-go">Total</th><th class="col-go">Salary</th><th class="col-go">Savings</th><th class="col-go">Total</th></tr>';
      let html = '';
      for (let y = 0; y <= years; y++) {
        const rowClass = y === phdYears ? ' class="graduation-row"' : '';
        html += '<tr' + rowClass + '><td class="td-year">' + y + '</td>';
        html += '<td class="col-not-go">' + fmt(noPhdSalaries[y]) + '</td><td class="col-not-go">' + fmt(noPhdSavings[y]) + '</td><td class="col-not-go">' + fmt(noPhd[y]) + '</td>';
        html += '<td class="col-go">' + fmt(phdSalaries[y]) + '</td><td class="col-go">' + fmt(phdSavings[y]) + '</td><td class="col-go">' + fmt(phd[y]) + '</td>';
        html += '</tr>';
      }
      tbody.innerHTML = html;
    }

    function drawChart(noPhd, phd, maxYear, phdYears, noPhdLayoffEnable, noPhdLayoffYear, phdLayoffEnable, phdLayoffYear) {
      if (assetChartInstance) {
        assetChartInstance.destroy();
        assetChartInstance = null;
      }
      const labels = [];
      for (let i = 0; i <= maxYear; i++) labels.push(i);

      const annotations = {};
      if (phdYears > 0 && phdYears <= maxYear) {
        annotations.graduation = {
          type: 'line',
          xMin: phdYears,
          xMax: phdYears,
          borderColor: 'rgba(248, 113, 113, 0.8)',
          borderWidth: 1.5,
          borderDash: [4, 4]
        };
      }
      if (noPhdLayoffEnable && noPhdLayoffYear > 0 && noPhdLayoffYear <= maxYear) {
        annotations.layoffNotGo = {
          type: 'line',
          xMin: noPhdLayoffYear,
          xMax: noPhdLayoffYear,
          borderColor: 'rgba(56, 189, 248, 0.9)',
          borderWidth: 1.5,
          borderDash: [6, 4]
        };
      }
      if (phdLayoffEnable && phdLayoffYear > 0 && phdLayoffYear <= maxYear) {
        annotations.layoffGo = {
          type: 'line',
          xMin: phdLayoffYear,
          xMax: phdLayoffYear,
          borderColor: 'rgba(52, 211, 153, 0.9)',
          borderWidth: 1.5,
          borderDash: [6, 4]
        };
      }

      const plugins = {
        zoom: {
          zoom: {
            wheel: { enabled: true },
            pinch: { enabled: true },
            mode: 'x'
          },
          pan: {
            enabled: true,
            mode: 'x'
          },
          limits: { x: { min: 0, max: maxYear } }
        }
      };
      if (Object.keys(annotations).length > 0) {
        plugins.annotation = { annotations: annotations };
      }

      const config = {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Not go',
              data: noPhd,
              borderColor: '#38bdf8',
              backgroundColor: 'rgba(56, 189, 248, 0.1)',
              fill: false,
              tension: 0.15,
              pointRadius: 0,
              pointHoverRadius: 4
            },
            {
              label: 'Go',
              data: phd,
              borderColor: '#34d399',
              backgroundColor: 'rgba(52, 211, 153, 0.1)',
              fill: false,
              tension: 0.15,
              pointRadius: 0,
              pointHoverRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              title: { display: true, text: 'Year' },
              min: 0,
              max: maxYear,
              grid: { color: 'rgba(71,85,105,0.3)' },
              ticks: { color: '#94a3b8', maxTicksLimit: 12 }
            },
            y: {
              title: { display: true, text: 'Total assets ($)' },
              beginAtZero: true,
              grid: { color: 'rgba(71,85,105,0.3)' },
              ticks: {
                color: '#94a3b8',
                callback: function(v) {
                  if (v >= 1e6) return (v/1e6).toFixed(1) + 'M';
                  return (v/1000) + 'K';
                }
              }
            }
          },
          plugins: {
            legend: { position: 'top', labels: { color: '#94a3b8', usePointStyle: true } },
            tooltip: {
              callbacks: {
                label: function(ctx) {
                  const v = ctx.raw;
                  return ctx.dataset.label + ': ' + (v >= 1e6 ? (v/1e6).toFixed(2) + 'M' : (Math.round(v)).toLocaleString());
                }
              }
            },
            ...plugins
          }
        }
      };

      const ctx = document.getElementById('assetChart').getContext('2d');
      assetChartInstance = new Chart(ctx, config);

      document.querySelectorAll('.chart-toolbar .range-btn').forEach(function(btn) {
        btn.classList.remove('active');
        if (btn.getAttribute('data-range') === 'all') btn.classList.add('active');
      });
    }

    function setChartTimeRange(years) {
      if (!assetChartInstance) return;
      const maxYear = assetChartInstance.data.labels.length - 1;
      const xScale = assetChartInstance.options.scales.x;
      if (years === 'all' || years >= maxYear) {
        xScale.min = 0;
        xScale.max = maxYear;
      } else {
        xScale.min = 0;
        xScale.max = Math.min(Number(years), maxYear);
      }
      assetChartInstance.update('none');
      const activeRange = years === 'all' ? 'all' : String(years);
      document.querySelectorAll('.chart-toolbar .range-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-range') === activeRange);
      });
    }

    document.querySelectorAll('.chart-toolbar .range-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const r = btn.getAttribute('data-range');
        setChartTimeRange(r === 'all' ? 'all' : parseInt(r, 10));
      });
    });
  </script>
</body>
</html>
